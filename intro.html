<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8">
    <title>CHAOS tutorials: Introduction to the CHAOS.Portal Javascript client</title>
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>
    <script src="../CHAOS.Portal.Client-JavaScript/src/CHAOS.Portal.Client.PortalClient.js" type="text/javascript"></script>

    <!-- <link rel="stylesheet" type="text/css" href="http://cdn.jsdelivr.net/syntaxhighlighter/3.0.83/styles/shThemeRDark.css"> -->
    <link rel="stylesheet" type="text/css" href="http://cdn.jsdelivr.net/syntaxhighlighter/3.0.83/styles/shThemeEclipse.css">
    <link href="style.css" rel="stylesheet" type="text/css">
    <link rel="stylesheet" type="text/css" href="http://cdn.jsdelivr.net/syntaxhighlighter/3.0.83/styles/shCore.css">
    <script type="text/javascript" src="http://cdn.jsdelivr.net/syntaxhighlighter/3.0.83/scripts/shCore.js"></script>
    <script type="text/javascript" src="http://cdn.jsdelivr.net/syntaxhighlighter/3.0.83/scripts/shBrushJScript.js"></script>
    <script type="text/javascript"
      src="http://cdn.jsdelivr.net/syntaxhighlighter/3.0.83/scripts/shBrushXml.js"></script>
    <script>

      $(document).ready(function(event) {

        // Calculate line numbers
        var setup_code = "";
        var line_count = 0;
        $('aside.code pre code#setup.language-javascript').each(function() {
          line_count = $(this).text().split("\n").length + 1
          setup_code = $(this).text();
        });

        // $('aside.code pre code[id!="setup"].language-javascript').each(function() {
        $('aside.code pre code.language-javascript').each(function() {
          var pre = $(this).parent();

          if ($(this).attr("id") != "setup") {
            pre.addClass('first-line: ' + line_count);

            // Add Javascript evaluate button
            var codeButton = $('<div class="try-code"><button>Try!<\/button><\/div>');
            codeButton.children('button').click(codeEval);
            pre.after(codeButton);

            // Save code in <code>-tag -- Google Prettify removes line-breaks
            // and so breaks the code.
            var code = setup_code + $(this).text();
            console.log(code);
            pre.parent().data('code', code);
          }


          // Remove code element - otherwise SyntaxHighlighter doesn't work
          var html = $(this).html();
          pre.html(html);

          pre.addClass('brush: js');
          pre.addClass('toolbar: false');
        });

        $('aside.code pre code.language-html').each(function() {
          var pre = $(this).parent();
          var html = $(this).html();
          pre.html(html);

          pre.addClass('brush: html');
          pre.addClass('toolbar: false');
        });

        SyntaxHighlighter.all();

      });

      function codeEval(event) {
        // console.log('Pressed!');

        var aside = $(this).parent().parent();
        console.log(aside.prop('tagName'));

        // Old code (before Prettify)
        // var code = aside.prevAll('aside').find('pre code').text();
        // code += aside.find('pre code').text();

        var code = aside.data('code');
        console.log(code);
        eval(code);

        // console.log('Unpressed!');
      }
    </script>
  </head>
  <body>
    <!-- Representation of code in HTML is for some reason weird but it seems consensus is
    <pre><code>CODE</code></pre>
    Check: http://stackoverflow.com/questions/4611591/code-vs-pre-vs-samp-for-inline-and-block-code-snippets
    -->

    <div id="body-column">
      <h1>Tutorial: CHAOS.Portal Javascript Client</h1>
      <h2>The first steps</h2>
      <p id="intro">
        The <dfn>CHAOS.Portal Javascript Client</dfn> is a communication client for
        <dfn>CHAOS.Portal</dfn><br>
        <dfn>CHAOS.Portal</dfn> is the web API for <a
          href="http://chaos-community.org"><dfn><abbr title="Cultural Heritage
            Archiving Open System">CHAOS</abbr></dfn></a>.<br>
      </p>
      <p>
        Javascript client for CHAOS.Portal is one of the easiest ways to start
        using CHAOS.<br>
        <br>
        This tutorial will teach you how to set up the client, connect to a
        CHAOS.Portal and retrieve object from the CHAOS database.
      </p>

      <section>
      <h3>Setting up</h3>
      <p>
      Import the Javascript CHAOS.Portal Client into your site.
      </p>

      <aside class="code">
      <pre><code class="language-html">&lt;script src="CHAOS.Portal.Client.PortalClient.js" type="text/javascript"&gt;&lt;/script&gt;</code></pre>
      </aside>

      <aside class="note">
        <p>
          All following code examples will be Javascript code, and should be
          included in your page between
          <code>&lt;script&gt;&lt;/script&gt;</code> tags or otherwise imported
          as Javascript into your site.
        </p>
      </aside>

      <p>
        The first thing we need to do is to instantiate the client.
      </p>

      <aside class="code">
      <pre><code id="setup" class="language-javascript">// Setup settings
var ChaosSettings = {
  "servicePath":"http://api.chaos-systems.com/",
  "clientGUID":"9f62060c-64ff-e14f-a8d5-d85a1e2e21b8",
  "accessPointGUID":"C4C2B8DA-A980-11E1-814B-02CEA2621172",
};
// Instantiate client
var client = new PortalClient(
                   ChaosSettings.servicePath,
                   ChaosSettings.clientGUID
                 );</code></pre>
      </aside>

      <p>
        <code>servicePath</code> is the URL at which your CHAOS.Portal
        is set up.
      </p>

      <p> Instantiating the <code>PortalClient</code> this way automatically
      sets up a session. When the session has been set up we are ready to use
      the CHAOS.Portal.<br>
      <br>
      We can add callbacks to <code>PortalClient.SessionAcquired()</code> in
      order to do work when the session has been set up:
      <!-- Next we need to set up a session. Session are for logging in with some -->
      <!-- user on the CHAOS.Portal server and thereby authenticating yourself with the -->
      <!-- server. In this case we don't need to login, and a session is automatically -->
      <!-- created for us. -->

      <!-- When the session is created, we are ready to grab objects from the CHAOS -->
      <!-- server. We can add event handlers to the SessionAcquired() event &#45; these -->
      <!-- will be called when a session has been set up for us. -->
      </p>

      <aside class="code">
      <pre><code class="language-javascript">client.SessionAcquired().Add(function(sender, sessionGUID) {
  alert("Session created: " + sessionGUID);
});</code></pre>
<!--       <pre><code class="language&#45;javascript">setTimeout(function() { -->
<!--   client.SessionAcquired().Add(function(sender, sessionGUID) { -->
<!--     alert("Session created: " + sessionGUID); -->
<!--   }); -->
<!-- }, 2000);</code></pre> -->
      </aside>

      <p>Now we are ready to get some objects!</p>
      </section>

      <section>
      <h3>Searching</h3>
      <p>
        The easiest way to retrieve some objects from a CHAOS database is to
        search.
      </p>

      <aside class="code">
      <pre><code class="language-javascript">// Add search schemas
ChaosSettings.schemas = [
  "5906a41b-feae-48db-bfb7-714b3e105396",
  "00000000-0000-0000-0000-000063c30000",
  "00000000-0000-0000-0000-000065c30000"
];
// Retrieve objects
client.SessionAcquired().Add(function(sender, sessionGUID) {
  client.Object_GetBySearch(
    showObjects                     // callback
    , "mut"                         // query
    , ChaosSettings.schemas         // schemas
    , "da"                          // langCode
    , null                          // sort
    , ChaosSettings.accessPointGUID // accessPointGuid
    , 0                             // pageIndex
    , 3                             // pageSize
    , true                          // includeMetadata
    , true                          // includeFiles
    , true                          // includeObjectRelations
    , false                         // includeAccessPoints
  );
});

function showObjects(serviceResult) {
  var count = serviceResult.MCM().Count();
  var totalcount = serviceResult.MCM().TotalCount();
  alert("Got " + count + "/" + totalcount + " objects");
  console.log(serviceResult.MCM().Results());
}</code></pre>
      </aside>

      <p>
        When the search results has been recieved from the CHAOS.Portal, the
        callback is invoked with <code>serviceResult</code> as its argument.
        The <code>serviceResult</code> has a number of fields, of which
        <code>MCM()</code> is the most important and the one we are going to be
        using.

      </p>

      <p>
        Let's add some error handling code to that call.
      </p>

      <aside class="code">
      <pre><code class="language-javascript">// Add search schemas
ChaosSettings.schemas = [
  "5906a41b-feae-48db-bfb7-714b3e105396",
  "00000000-0000-0000-0000-000063c30000",
  "00000000-0000-0000-0000-000065c30000"
];
// Retrieve objects
client.SessionAcquired().Add(function(sender, sessionGUID) {
  client.Object_GetBySearch(
    showObjects                     // callback
    , "*"                         // query
    , ChaosSettings.schemas         // schemas
    , "da"                          // langCode
    , null                          // sort
    , ChaosSettings.accessPointGUID // accessPointGuid
    , 0                             // pageIndex
    , 3                             // pageSize
    , true                          // includeMetadata
    , true                          // includeFiles
    , true                          // includeObjectRelations
    , false                         // includeAccessPoints
  );
});

function showObjects(serviceResult) {
  if (serviceResult.WasSuccess() &amp;&amp; serviceResult.MCM().WasSuccess()) {
    var count = serviceResult.MCM().Count();
    var totalcount = serviceResult.MCM().TotalCount();
    alert("Got " + count + "/" + totalcount + " objects");
    console.log(serviceResult.MCM().Results());
  } else {
    if (!serviceResult.WasSuccess()) {
      alert("Portal error: " + serviceResult.Error());
      console.log(serviceResult.Error());
    } else if (!serviceResult.MCM().WasSuccess()) {
      alert("MCM error: " + serviceResult.MCM().Error());
      console.log(serviceResult.MCM().Error());
    }
  }
}</code></pre>
      </aside>

      </section>

      <footer>
        <a class="prev-page" href="index.html">&larr; Back up: Overview
          </a>
        <a class="next-page" href="javascript_login.html">Next up: Logging in
          &rarr;</a>
        <!-- &raquo; / &laquo; -->
      </footer>
    </div>
  </body>
</html>
